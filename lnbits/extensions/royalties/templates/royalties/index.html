{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block page %}
<div class="row q-col-gutter-md">
  <div class="col-12 col-md-7 q-gutter-y-md">
    {% include "royalties/partials/_create_royalty_account.html" %} 
    {% include "royalties/partials/_royalty_accounts_table.html" %} 
  </div>
  <div class="col-12 col-md-5 col-lg-5 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <h6 class="text-subtitle1 q-my-none q-mb-sm"><strong>LN</strong>bits Royalties Extension</h6>
        <p>
          The extension allows LNbits developers to charge a royalty fee per transaction when clients use their extension.
        </p>
        <p>
          Follow the instructions in the setup code section. It requires you add and execute the functions provided to allow a royalty fee to be charged.        
        </p>
      </q-card-section>
      <q-card-section class="q-pa-none">
        <q-separator></q-separator>
        <q-list>  {% include "royalties/partials/_api.html" %}  </q-list>
      </q-card-section>
    </q-card>
  </div>
</div>
{% endblock %} {% block scripts %} {{ window_vars(user) }}
<script>
  new Vue({
    el: '#vue',
    mixins: [windowMixin],
    data: function () {
      return {
        form:{
          royalty:{
            data:{}
          }
        },
        table:{
          data:{
            columns:[
              { name: 'b1', align: 'left', label: '', field: ''},
              { name: 'id', align: 'left', label: 'ID', field: 'id', sortable: true},
              { name: 'wallet', align: 'left', label: 'Wallet', field: 'wallet', sortable: true}
            ],
            data:[]
          }
        }
      }
    },
    methods:{
      async formSubmit(){
        let res, payload
        payload = {...this.form.royalty.data}
        res = await LNbits.api
          .request('POST',
          `/royalties/api/v1/account`, 
          this.g.user.wallets[0].adminkey,
          payload
          )
          res.data.success && (
              this.table.data.data.push(res.data.success),
              this.formReset(),
              this.$q.notify('Royalty account created')
              )
      },
      formReset(){
        for(name in this.form){
          for(items in this.form[name]){
              items == 'data' 
              ? this.form[name][items] = {}
              : this.form[name][items] = false
          } 
        }
      },
      async deleteAccount(id){
        const {data} = await LNbits.api
          .request(
            'DELETE',
            `/royalties/api/v1/account?id=${id}`,
            this.g.user.wallets[0].adminkey,
            )
        data.success &&(
          this.table.data.data = this.table.data.data.filter(x=> x.id !== id),
          this.$q.notify({
            timeout: 5000,
            type: 'primary',
            message: `Account successfully deleted!`,
            // caption: response.data.lnurl_response
          })
        )
      },
      confirm(p){
        this.$q.dialog({
          title: p.title || 'Confirm',
          message: p.msg || 'Would you like to continue?',
          cancel: true,
          persistent: true
        }).onOk(() => {
          p?.ok == 'deleteAccount' && this.deleteAccount(p.id)
        }).onCancel(() => {
        }).onDismiss(() => {
        })
      },
      exportCSV(){
        LNbits.utils.exportCSV(
            this.table.data.columns.filter((x,i)=> i >0), 
            this.table.data.data)
      }
    },
    created: async function () {
      let res
      res = await LNbits.api
        .request(
          'GET',
          `/royalties/api/v1/account`, 
          this.g.user.wallets[0].adminkey
        )
        res.data.success && (this.table.data.data = res.data.success)
    }
  })
</script>
{% endblock %}
